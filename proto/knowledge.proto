syntax = "proto3";

package knowledge;

option go_package = "github.com/EricMurray-e-m-dev/StartupMonkey/proto";

// Knowledge Service - State management for MAPE-K system
service KnowledgeService {
  // Detection operations
  rpc RegisterDetection(RegisterDetectionRequest) returns (DetectionResponse);
  // Checks if a detection with the given key is currently active
  rpc IsDetectionActive(DetectionKeyRequest) returns (DetectionStatusResponse);
  // Retrieves all active (unresolved) detections, optionally filtered by database
  rpc GetActiveDetections(DatabaseFilterRequest) returns (DetectionListResponse);
  // Marks a detection as resolved, removing it from the active detections list
  rpc MarkDetectionResolved(ResolveDetectionRequest) returns (Response);

  // Registers a new action in the knowledge base
  rpc RegisterAction(RegisterActionRequest) returns (ActionResponse);
  // Updates the status of an existing action (e.g., pending, completed, failed)
  rpc UpdateActionStatus(UpdateActionRequest) returns (Response);
  // Retrieves all pending actions, optionally filtered by database
  rpc GetPendingActions(DatabaseFilterRequest) returns (ActionListResponse);

  // Registers a new database with the knowledge service
  rpc RegisterDatabase(RegisterDatabaseRequest) returns (DatabaseResponse);
  // Retrieves detailed information about a specific registered database
  rpc GetDatabase(GetDatabaseRequest) returns (GetDatabaseResponse);
  // Lists all registered databases in the system
  rpc ListDatabases(ListDatabasesRequest) returns (DatabaseListResponse);
  // Updates the health status of a registered database
  rpc UpdateDatabaseHealth(UpdateDatabaseHealthRequest) returns (Response);
  // Removes a database from the registry
  rpc UnregisterDatabase(UnregisterDatabaseRequest) returns (Response);

  // Retrieves the current system configuration
  rpc GetSystemConfig(GetSystemConfigRequest) returns (SystemConfig);
  // Saves or updates the system configuration settings
  rpc SaveSystemConfig(SaveSystemConfigRequest) returns (Response);
  // Retrieves the current operational status of the system
  rpc GetSystemStatus(GetSystemStatusRequest) returns (SystemStatus);
  // Clears all data from the knowledge service (detections, actions, etc.)
  rpc FlushAllData(FlushAllDataRequest) returns (FlushAllDataResponse);
}

// Detection messages
message RegisterDetectionRequest {
  string id = 1;
  string key = 2;
  string severity = 3;
  string category = 4;
  string database_id = 5;
  double value = 6;
  int64 created_at = 7;
}

message DetectionKeyRequest {
  string key = 1;
}

message DetectionStatusResponse {
  bool is_active = 1;
  string detection_id = 2;
}

message DatabaseFilterRequest {
  string database_id = 1;
}

message DetectionResponse {
  bool success = 1;
  string message = 2;
  string detection_id = 3;
}

message DetectionListResponse {
  repeated Detection detections = 1;
}

message Detection {
  string id = 1;
  string key = 2;
  string state = 3;
  string severity = 4;
  string category = 5;
  string database_id = 6;
  double value = 7;
  string action_id = 8;
  string resolved_by = 9;
  int64 created_at = 10;
  int64 last_seen = 11;
}

message ResolveDetectionRequest {
  string detection_id = 1;
  string solution = 2;
}

// Action messages
message RegisterActionRequest {
  string id = 1;
  string detection_id = 2;
  string action_type = 3;
  string database_id = 4;
  int64 created_at = 5;
}

message ActionResponse {
  bool success = 1;
  string message = 2;
  string action_id = 3;
}

message UpdateActionRequest {
  string action_id = 1;
  string status = 2;
  string message = 3;
  string error = 4;
  int64 timestamp = 5;
}

message ActionListResponse {
  repeated Action actions = 1;
}

message Action {
  string id = 1;
  string detection_id = 2;
  string action_type = 3;
  string database_id = 4;
  string status = 5;
  int64 created_at = 6;
}

// Database messages
message RegisterDatabaseRequest {
  string database_id = 1;
  string connection_string = 2;
  string database_type = 3;
  string database_name = 4;
  string host = 5;
  int32 port = 6;
  string version = 7;
  int64 registered_at = 8;
  map<string, string> metadata = 9;
}

message DatabaseResponse {
  bool success = 1;
  string message = 2;
}

message GetDatabaseRequest {
  string database_id = 1;
}

message GetDatabaseResponse {
  bool found = 1;
  string database_id = 2;
  string connection_string = 3;
  string database_type = 4;
  string database_name = 5;
  string host = 6;
  int32 port = 7;
  string version = 8;
  int64 registered_at = 9;
  int64 last_seen = 10;
  string status = 11;
  double health_score = 12;
  map<string, string> metadata = 13;
}

message ListDatabasesRequest {
  // Filter criteria for listing databases
}

message DatabaseListResponse {
  repeated RegisteredDatabase databases = 1;
}

message RegisteredDatabase {
  string database_id = 1;
  string database_type = 2;
  string database_name = 3;
  string host = 4;
  int32 port = 5;
  string version = 6;
  int64 registered_at = 7;
  int64 last_seen = 8;
  string status = 9;
  double health_score = 10;
}

message UpdateDatabaseHealthRequest {
  string database_id = 1;
  int64 last_seen = 2;
  string status = 3;
  double health_score = 4;
}

message UnregisterDatabaseRequest {
  string database_id = 1;
}

// System statistics messages
message GetSystemStatsRequest {
  // Request parameters for system-wide statistics
}

message GetSystemStatsResponse {
  int32 total_databases = 1;
  int32 healthy_databases = 2;
  int32 degraded_databases = 3;
  int32 offline_databases = 4;
  int32 total_detections = 5;
  int32 active_detections = 6;
  int32 resolved_detections = 7;
  int32 total_actions = 8;
  int32 actions_queued = 9;
  int32 actions_executing = 10;
  int32 actions_completed = 11;
  int32 actions_failed = 12;
  int64 uptime_seconds = 13;
}

// Configuration management messages
message DatabaseConfig {
  string id = 1;
  string name = 2;
  string connection_string = 3;
  string type = 4; // postgres, mysql, sqlite
  bool enabled = 5;
}

message DetectionThresholds {
  double connection_pool_critical = 1; // e.g., 0.8 = 80%
  int64 sequential_scan_threshold = 2; // e.g., 1000
  double sequential_scan_delta = 3; // e.g., 100.0
  double p95_latency_ms = 4; // e.g., 100.0
  double cache_hit_rate_threshold = 5; // e.g., 0.9 = 90%
}

message SystemConfig {
  DatabaseConfig database = 1; // Single DB for MVP
  DetectionThresholds thresholds = 2;
  bool onboarding_complete = 3;
  string execution_mode = 4;
}

message SystemStatus {
  bool configured = 1;
  bool onboarding_complete = 2;
  map<string, string> service_states = 3;  // e.g., {"collector": "connected"}
}

message GetSystemConfigRequest {}

message SaveSystemConfigRequest {
  SystemConfig config = 1;
}

message GetSystemStatusRequest {}

message FlushAllDataRequest {}

message FlushAllDataResponse {
  bool success = 1;
  string message = 2;
}

// Generic response
message Response {
  bool success = 1;
  string message = 2;
}