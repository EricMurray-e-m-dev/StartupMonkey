name: Integration Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ---------------------------------------------------------
      # Checkout
      # ---------------------------------------------------------
      - uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Setup Go
      # ---------------------------------------------------------
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # ---------------------------------------------------------
      # Enable Buildx + Load Cache
      # ---------------------------------------------------------
      - uses: docker/setup-buildx-action@v3

      - name: Restore Docker build cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ runner.os }}-

      # ---------------------------------------------------------
      # Prebuild all service images (cached)
      # ---------------------------------------------------------
      - name: Pre-build service images
        run: |
          build() {
            NAME=$1
            CONTEXT=$2

            echo "=== Building $NAME ==="
            docker buildx build \
              --cache-from type=local,src=/tmp/.buildx-cache \
              --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
              --load \
              -t $NAME \
              $CONTEXT
          }

          build sm-knowledge ./knowledge
          build sm-collector ./collector
          build sm-analyser ./analyser
          build sm-executor ./executor
          
      - name: Move updated build cache
        if: success()
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # ---------------------------------------------------------
      # Clean Docker environment (ensures fresh test start)
      # ---------------------------------------------------------
      - name: Clean Docker environment
        run: |
          docker ps -aq | xargs -r docker rm -f || true
          docker network prune -f || true
          docker volume prune -f || true

      # ---------------------------------------------------------
      # Run Integration Tests
      # ---------------------------------------------------------
      - name: Run integration tests
        run: |
          cd tests/integration
          go test -v -timeout 10m
        env:
          DOCKER_BUILDKIT: 1

      # ---------------------------------------------------------
      # Logs on failure
      # ---------------------------------------------------------
      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Showing logs for all test containers ==="
          docker ps -a
          for c in $(docker ps -a --format '{{.Names}}' | grep startupmonkey-test); do
            echo "=== Logs for $c ==="
            docker logs $c || true
          done

      # ---------------------------------------------------------
      # Cleanup
      # ---------------------------------------------------------
      - name: Cleanup
        if: always()
        run: |
          docker ps -aq | xargs -r docker rm -f || true
          docker network prune -f || true
          docker volume prune -f || true
